# 開發板配置規範 


## 開發板配置庫結構
aily blockly庫基本遵循google blockly庫結構，使用npm套件管理形式管理庫的版本及相關必要資訊。一個aily blockly庫的結構如下：
```
board_name  
 |- board.json             // 開發板配置檔案
 |- board.webp             // 開發板圖片
 |- package.json           // npm套件管理檔案
 |- example                // 範例程式資料夾
    |- <範例程式列表>
 |- template               // 初始模板資料夾
    |- package.json
    |- project.abi
```

## board-name.json
這裡提供一個Arduino UNO的做參考：
```json
{
    "name": "Arduino UNO",
    "version":"1.0.0",
    "description": "Arduino UNO standard compatible board",
    "compilerTool": "aily-builder",  // 預設使用的編譯工具
    "type": "arduino:avr:uno",  // 在arduino中的類型
    "mode": ["arduino", "micropython"],  // 支援的開發框架
    "compilerParam": "compile -v -b arduino:avr:uno",  // 編譯用命令
    "uploadParam": "upload -v -b arduino:avr:uno -p ${serial}",  // 編上傳用命令
    "analogPins": [
        ["A0","A0"],["A1","A1"],["A2","A2"],["A3","A3"],["A4","A4"],["A5","A5"]
    ],
    "digitalPins": [
        ["0","0"],["1","1"],["2","2"],["3","3"],["4","4"],["5","5"],["6","6"],["7","7"],["8","8"],["9","9"],["10","10"],["11","11"],["12","12"],["13","13"],["A0","A0"],["A1","A1"],["A2","A2"],["A3","A3"],["A4","A4"],["A5","A5"]
    ],
    "pwmPins": [
        ["3","3"],["5","5"],["6","6"],["9","9"],["10","10"],["11","11"]
    ],
    "serialPort": [
        ["Serial","Serial"]
    ],
    "serialSpeed": [
        ["1200","1200"],["9600","9600"],["14400","14400"],["19200","19200"],["38400","38400"],["57600","57600"],["115200","115200"]
    ],
    "spi": [
        ["SPI","SPI"]
    ],
    "spiPins": {
        "SPI": [
            ["MOSI",11],["MISO",12],["SCK",13]
        ]
    },
    "spiClockDivide": [
        ["2 (8MHz)","SPI_CLOCK_DIV2"],["4 (4MHz)","SPI_CLOCK_DIV4"],["8 (2MHz)","SPI_CLOCK_DIV8"],["16 (1MHz)","SPI_CLOCK_DIV16"],["32 (500KHz)","SPI_CLOCK_DIV32"],["64 (250KHz)","SPI_CLOCK_DIV64"],["128 (125KHz)","SPI_CLOCK_DIV128"]
    ],
    "i2c": [
        ["I2C","Wire"]
    ],
    "i2cPins": {
        "Wire": [
            ["SDA","A4"],["SCL","A5"]
        ]
    },
    "i2cSpeed": [
        ["100kHz","100000L"],["400kHz","400000L"]
    ],
    "builtinLed": [
        ["BUILTIN_LED","13"]
    ],
    "interruptPins": [
        ["2","2"],["3","3"]
    ],
    "interruptMode": [
        ["LOW","LOW"],["RISING","RISING"],["FALLING","FALLING"],["CHANGE","CHANGE"]
    ]
}
```

### 編譯上傳配置
```json
    "compilerTool": "aily-builder",  // 使用的編譯工具，目前是arduino-cli，不需要更改
    "core": "arduino:avr@1.8.5",    // 開發板核心及對應版本號
    "type": "arduino:avr:uno",      // 開發板類型
    "compilerParam": "compile -v -b arduino:avr:uno",  //編譯參數
    "uploadParam": "upload -v -b arduino:avr:uno -p ${serial}",  //上傳參數，其中${serial}是串口變數，實際使用時會替換成用戶選擇的串口
```

#### 可用配置
 ${serial} 為用戶選擇的設備串口  
 ${mac} 為無線下載時用戶選擇的設備，可藍牙，可wifi  
 ${usb} 為usb下載時用戶選擇的設備  

#### arduino-cli參考
當前配置參考自arduino cli配置，可見[arduino-cli文檔](https://arduino.github.io/arduino-cli)  

你可能使用到的命令：
```bash
arduino-cli core list // 列出已安裝的核心
arduino-cli board search // 列出可用的開發板
```

### 引腳等配置
```json
"digitalPins": [
    ["0","0"],["1","1"],["2","2"],["3","3"],["4","4"],["5","5"],["6","6"],["7","7"],["8","8"],["9","9"],["10","10"],["11","11"],["12","12"],["13","13"],["A0","A0"],["A1","A1"],["A2","A2"],["A3","A3"],["A4","A4"],["A5","A5"]
]
```
這些配置是用於block載入時調用的，在對應位置添加${board.varName}即可，在庫檔案的block.json中使用方式如下：
```json
[
  {
    "inputsInline": true,
    "message0": "數位引腳%1",
    "type": "io_pin_digi",
    "colour": "#00C48C",
    "args0": [
      {
        "type": "field_dropdown",
        "name": "PIN",
        "options": "${board.digitalPins}"
      }
    ],
    "output": "Any"
  }
]
```
在庫載入時，對應位置的`${board.digitalPins}`會自動替換成`board.json`中的`digitalPins`配置。  

## package.json
基本遵循npm套件管理規範，需注意的是其中`boardDependencies`項包含了開發板編譯、上傳等動作要用到的依賴，針對不同核心的參考依賴如下：
```json
// AVR核心，如Arduino UNO\MEGA\LEONARDO等開發板
{
    "@aily-project/compiler-avr-gcc": "7.3.0",
    "@aily-project/tool-avrdude": "6.3.0",
    "@aily-project/sdk-avr": "1.8.6",
    "@aily-project/tool-ctags": "5.8.0"
}
```  
```json
// Renesas RA4M1核心，如Arduino UNO R4系列
{
    "@aily-project/compiler-arm-none-eabi-gcc": "7.2.1",
    "@aily-project/tool-bossac": "1.9.1",
    "@aily-project/sdk-renesas_uno": "1.3.2",
    "@aily-project/tool-ctags": "5.8.0",
    "@aily-project/tool-dfu-util": "0.11.0"    
}
```
```json
// ESP32核心
{
    "@aily-project/compiler-esp-x32": "14.2.0",
    "@aily-project/tool-esptool_py": "5.1.0",
    "@aily-project/sdk-esp32": "3.3.1",
    "@aily-project/tool-idf_esp32": "5.5.0",
    "@aily-project/tool-ctags": "5.8.0"
}
```
```json
// ESP32C3核心
{
    "@aily-project/compiler-esp-rv32": "14.2.0",
    "@aily-project/tool-esptool_py": "5.1.0",
    "@aily-project/sdk-esp32": "3.3.1",
    "@aily-project/tool-idf_esp32c3": "5.5.0",
    "@aily-project/tool-ctags": "5.8.0"
}
```
```json
// ESP32S3核心
{
    "@aily-project/compiler-esp-x32": "14.2.0",
    "@aily-project/tool-esptool_py": "5.1.0",
    "@aily-project/sdk-esp32": "3.3.1",
    "@aily-project/tool-idf_esp32s3": "5.5.0",
    "@aily-project/tool-ctags": "5.8.0"
}
```
```json
// ESP32C6核心 待更新
```
```json
// ESP32H2核心 待更新
```
```json
// ESP32S2核心 待更新
```
```json
// ESP32P4核心 待更新
```
```json
// RP2040，如樹莓派Pico 待更新
```
```json
// RP2350，如樹莓派Pico2  待更新
```
```json
// SAM3X，如Arduino Due 待更新
```

## 初始專案模板（template）
每個開發板套件中，帶有一個`template`目錄，其中存放的是新建專案後載入的模板專案。
可以修改`template\package.json`，添加預設載入的庫，如[Grove Beginner Kit的package.json](grove_beginner_kit\template\package.json)
```json
{
  "name": "project_",
  "version": "1.0.0",
  "description": "",
  "dependencies": {
    "@aily-project/board-grove_beginner_kit": "^1.0.0",
    "@aily-project/lib-core-io": "1.0.0",
    "@aily-project/lib-core-logic": "0.0.1",
    "@aily-project/lib-core-loop": "0.0.1",
    "@aily-project/lib-core-math": "0.0.1",
    "@aily-project/lib-core-text": "0.0.1",
    "@aily-project/lib-core-serial": "0.0.1",
    "@aily-project/lib-core-time": "0.0.1",
    "@aily-project/lib-core-variables": "1.0.1",
    "@aily-project/lib-dht": "1.0.0",
    "@aily-project/lib-bmp280": "0.0.1",
    "@aily-project/lib-u8g2": "1.0.0",
    "@aily-project/lib-core-tone": "0.0.1",
    "@aily-project/lib-lis3dhtr": "0.0.1"
  }
}
```

`template\project.abi`為對應的blockly工作區檔案，預設的project.abi通常如下：
```json
{
  "blocks": {
    "languageVersion": 0,
    "blocks": [
      {
        "type": "arduino_setup",
        "id": "arduino_setup_id0",
        "x": 30,
        "y": 30,
        "deletable": false 
      },
      {
        "type": "arduino_loop",
        "id": "arduino_loop_id0",
        "x": 30,
        "y": 290,
        "deletable": false 
      }
    ]
  }
}
```
你也可以把預先編輯好的專案寫入其中，用戶使用該開發板後新建專案後，即會自動載入上此程式。
