# 庫規範

## 庫結構
aily blockly庫基本遵循google blockly庫結構(當前使用版本為blockly 11)，使用npm套件管理形式管理庫的版本及相關必要資訊。一個aily blockly庫的結構如下：
```
library-name  
 |- block.json             // aily blockly block檔案
 |- generator.js           // aily blockly generator檔案
 |- toolbox.json           // aily blockly toolbox檔案
 |- package.json           // npm套件管理檔案
 |- src.7z                 // Arduino庫原始檔案，請使用7z極限壓縮後放在庫中
 |- readme.md              // 說明檔案，如果使用了開源庫，請進行說明
```

## block.json
aily blockly json在原始的blockly json上進行了擴展。這裡以servo lib（舵機庫）為例進行說明，舵機庫json如下：  
```json
[
    {
        "inputsInline": true,
        "message0": "舵機%1移動到%2",
        "type": "servo_write",
        "args0": [
            {
                "type": "field_variable",
                "name": "OBJECT",
                "variable": "servo1",
                "variableTypes": [
                    "Servo"
                ],
                "defaultType": "Servo"
            },
            {
                "type": "field_number",
                "name": "ANGLE",
                "value": 0
            }
        ],
        "previousStatement": null,
        "nextStatement": null,
        "colour": "#03a9f4"
    },
    {
        "inputsInline": true,
        "message0": "舵機%1連接到引腳%2",
        "type": "servo_attach",
        "args0": [
            {
                "type": "field_variable",
                "name": "OBJECT",
                "variable": "servo1",
                "variableTypes": [
                    "Servo"
                ],
                "defaultType": "Servo"
            },
            {
                "type": "field_dropdown",
                "name": "PIN1",
                "options": "${board.digitalPins}"
            }
        ],
        "previousStatement": null,
        "nextStatement": null,
        "colour": "#03a9f4"
    }
]
```

### block配置  
json檔案中`blocks陣列`即是具體的block配置，可以參照[blockly官方文檔](https://developers.google.com/blockly/guides/create-custom-blocks/define-blocks)了解相關配置。  
單一block範例如下：  

```json
{
    "inputsInline": true,              // block樣式，true輸入項目為一行顯示，flase為多行顯示
    "message0": "舵機%1連接到引腳%2",   // block資訊，定義該block上顯示的內容
    "type": "servo_attach",           // block類型，該參數必須是唯一的
    "previousStatement": null,         // 前置連接，配置該block之前的block類型  
    "nextStatement": null,             // 後置連接，配置該block之後的block類型  
    "colour": "#03a9f4",               // block顏色
    "args0": [                         // 輸入項
        {
            "type": "field_variable",
            "name": "OBJECT",
            "variable": "servo1",
            "variableTypes": [
                "Servo"
            ],
            "defaultType": "Servo"
        },
        {
            "type": "field_dropdown",
            "name": "PIN1",
            "options": "${board.digitalPins}"
        }
    ]
}
```



## generator.js 
generator.js負責將block轉換成程式碼，每一個block都有一個對應的generator函數。對於Arduino庫，generator函數編寫形式可參考：
```javascript
Arduino.forBlock['servo_attach'] = function(block, generator) {
  // 實現程式碼參考blockly官方文檔
  return ''
};

Arduino.forBlock['servo_write'] = function(block, generator) {
  // 實現程式碼參考blockly官方文檔
  return ''
};

```

### 添加附加程式碼
在generator.js中block對應的程式碼使用retuen返回，對於大多數Arduino除了block對應程式碼外，還需要添加額外的附加程式碼。如調用servo庫需要添加庫引用，並創建一個Servo物件：
```c++
#include <Servo.h>
Servo myservo;
```
此時可在generator.js對應的函數中添加如下語句用以在程式其他位置添加庫引用和新建物件語句：
```javascript
Arduino.forBlock['servo_attach'] = function(block, generator) {
  generator.addLibrary('#include <Servo.h>','#include <Servo.h>');
  generator.addObject('Servo myservo','Servo myservo');
  // 實現程式碼參考blockly官方文檔
  return ''
};
```

可用的函數有：
```javascript
addMacro(tag, code);
addLibrary(tag, code);
addVariable(tag, code);
addObject(tag, code);
addFunction(tag, code);
addSetupBegin(tag, code);
addSetup(tag, code); //系統預設，不建議庫使用
addSetupEnd(tag, code);
addLoopBegin(tag, code);
addLoop(tag, code); //系統預設，不建議庫使用
addLoopEnd(tag, code);
```
其中tag為避免重複添加程式碼的標籤，code是實際插入的程式碼。
使用這些函數，可以將對應的程式碼分別加入到程式的以下位置：

```c++
// [巨集定義 macro] 使用generator.addMacro可向該部分添加程式碼
#defined PIN 3
// [庫引用 library] 使用generator.addLibrary可向該部分添加程式碼
#include <Servo.h>
// [變數 variable] 使用generator.addVariable可向其中添加程式碼
static const int servoPin = 4;
// [物件 object] 使用generator.addObject可向該部分添加程式碼
Servo servo1;
// [函數 function] 使用generator.addFunction可向該部分添加程式碼

void setup() {
// [初始化 setup Begin] 使用generator.addSetupBegin可向該部分添加程式碼
    servo1.attach(servoPin);
    
// [初始化 setup] 使用generator.addSetup可向該部分添加程式碼(系統預設，不建議庫使用)
    Serial.begin(115200);

// [初始化 setup End] 使用generator.addSetupEnd可向該部分添加程式碼

}

void loop() {
// [主程式 loop Begin] 使用generator.addLoopBegin可向該部分添加程式碼

// [主程式 loop] 使用generator.addLoop可向該部分添加程式碼(系統預設，不建議庫使用)
    for(int posDegrees = 0; posDegrees <= 180; posDegrees++) {
        servo1.write(posDegrees);
        Serial.println(posDegrees);
        delay(20);
    }

    for(int posDegrees = 180; posDegrees >= 0; posDegrees--) {
        servo1.write(posDegrees);
        Serial.println(posDegrees);
        delay(20);
    }

// [主程式 loop End] 使用generator.addLoopEnd可向該部分添加程式碼

}
```

### 注意事項
如果在generator.js需要創建函數，請不要創建全域函數，使用如下方式將函數定義到Arduino中，如：
```js
Arduino.newFunction = function(value) {
  return 'ok';
};
```

## toolbox.json 
Toolbox是呈現在blockly介面左側的block選單，範例如下：
```json
{
    "kind": "category",
    "name": "Servo",
    "contents": [
        {
            "kind": "block",
            "type": "servo_attach"
        },
        {
            "kind": "block",
            "type": "servo_write"
        }
    ]
}
```

## package.json
版本控制檔案，採用npm套件管理,範例如下：
```json
{
    "name": "@aily-project/lib-servo",  // 庫的套件名以 @aily-project/lib- 開頭
    "nickname":"舵機驅動庫",             // 用於在庫管理器中顯示的名稱
    "author": "aily Project",
    "description": "舵機控制支援庫，支援Arduino UNO、MEGA、ESP8266、ESP32等開發板", // 簡短的介紹，不超過50字
    "version": "0.0.1",
    "compatibility": {                  // 相容性說明，支援的核心和電壓
        "type": [                       // 如果為[]，則為通用庫，相容所有開發板
            "arduino:avr:uno",
            "esp32:esp32:esp32",
            "esp32:esp32:esp32c3",
            "esp32:esp32:esp32s3",
            "arduino:renesas_uno:nanor4",
            "arduino:renesas_uno:nanor4"
        ],
        "voltage": [3.3,5]
    },
    "keywords": [                       // keywords可以輔助搜尋庫，建議其中添加分類名、函數名等
        "aily",
        "blockly",
        "servo",
        "servo_attach",
        "servo_write",
    ],
    "scripts": {},
    "dependencies": {},                // 該庫依賴了其他庫
    "devDependencies": {}
}
```

### 套件名命名規範
庫以@aily-project/lib-xxxx形式命名，如@aily-project/lib-servo。
如果庫是大部分開發板通用的庫，我將其稱為核心庫，以@aily-project/lib-core-xxxx形式命名，如@aily-project/lib-core-io。

## 優化/簡化方案
在沒有歧義的前提下，盡可能簡化庫的調用，讓用戶透過盡量少操作，就能正常使用庫，如：
0. toolbox中如果有輸入變數，可以用使用影子block填充；還可以提供一些常用block搭配組合，組合成程式段，讓用戶直接使用。
1. 一些引腳功能需要初始化，如調用`digitalWrite(5,HIGH)`時，對應的初始化則為`pinMode(5,OUTPUT)`。推薦block庫在調用digitalWrite、digitalRead相關塊時，可以自動向程式setup部分添加對應的pinMode程式碼。
2. 一些庫需要初始化，如servo庫，需要使用`myservo.attach(9)`，指定舵機連接的引腳，然後再使用`myservo.write(val)`控制舵機轉動角度。這個庫建議在保留原本的attach、write塊的同時，再提供一個簡化的block，允許用戶直接指定某引腳上的舵機轉動到多少角度。
3. 對於IIC裝置，如果IIC地址只有一個，則block中不顯示其IIC地址；如果IIC地址有多個，則應該使用field_dropdown，提供選單讓用戶選擇地址，且預設地址應該放到選單第一位。
4. 當Arduino庫函數的參數為回調函數時，如onebutton庫中`button.attachDoubleClick(doubleClick)`,doubleClick為回調函數，則應該創建一個主體為doubleClick函數block，並在generator.js中向程式的setup部分中添加程式碼`button.attachDoubleClick(doubleClick)`，向程式loop部分添加`button.tick()`。

## 擴展編寫  
允許block使用擴展(extension),使用方法遵循blockly定義：
```json
    {
        "type": "blinker_init_wifi",
        "message0": "初始化Blinker WiFi模式 %1",
        "args0": [
            {
                "type": "field_dropdown",
                "name": "MODE",
                "options": [
                    [
                        "手動配網",
                        "手動配網"
                    ],
                    [
                        "EspTouch V2",
                        "EspTouchV2"
                    ]
                ]
            }
        ],
        "extensions": ["blinker_init_wifi_extension"],
        "previousStatement": null,
        "nextStatement": null,
        "colour": "#03A9F4",
        "inputsInline": false
    },
```
可以直接在generator.js中定義擴展。註冊前請添加檢查語句，避免擴展重複載入，如：  
```js
// 避免重複載入
if (Blockly.Extensions.isRegistered('blinker_init_wifi_extension')) {
  Blockly.Extensions.unregister('blinker_init_wifi_extension');
}

Blockly.Extensions.register('blinker_init_wifi_extension', function() {
// 實現程式碼
})
```

## 在庫中獲取當前開發板配置  
### block.json中獲取
block.json檔案中，可以透過${board.name}獲取到當前載入的`board.json`配置。
如serial_begin block中：
```json
{
"inputsInline": true,
"message0": "初始化串口%1 設定波特率為%2",
"type": "serial_begin",
"colour": "#48c2c4",
"args0": [
    {
    "type": "field_dropdown",
    "name": "SERIAL",
    "options": "${board.serialPort}"
    },
    {
    "type": "field_dropdown",
    "name": "SPEED",
    "options": "${board.serialSpeed}"
    }
],
"previousStatement": null,
"nextStatement": null
}
```
透過`${board.serialPort}`、`${board.serialSpeed}`獲取到了開發板可用的串口、及波特率配置。庫在載入後，會自動替換成：
```json
{
    "inputsInline": true,
    "message0": "初始化串口%1 設定波特率為%2",
    "type": "serial_begin",
    "colour": "#48c2c4",
    "args0": [
        {
        "type": "field_dropdown",
        "name": "SERIAL",
        "options": [
            ["Serial","Serial"]
        ]
        },
        {
        "type": "field_dropdown",
        "name": "SPEED",
        "options": [
            ["1200","1200"],["9600","9600"],["14400","14400"],["19200","19200"],["38400","38400"],["57600","57600"],["115200","115200"]
        ]
        }
    ],
    "previousStatement": null,
    "nextStatement": null
}
```

### generator.js中獲取
generator.js檔案中，可以透過window['boardConfig']獲取到當前載入的`board.json`配置。
可以透過以下方法，判斷開發板配置，然後載入不同的內容
```js
// 判斷開發板核心
if (window['boardConfig'].core.indexOf('esp32') > -1) {
}
// 判斷開發板名稱
if (window['boardConfig'].name.indexOf('ai-vox') > -1) {
}
```

## src.7z打包規範
src.7z中存放對應的庫原始碼，對應的src目錄路徑為下：  
```
src  
 |- library1
    |- library1.h
    |- library1.cpp   
 |- library2           
 |- library3           
```
一個blockly庫中，可以有多個原始碼庫。  
打包時直接在src目錄右鍵 > `壓縮到 7z檔案`即可，如庫較大，請使用7z極限壓縮。
