# ライブラリ仕様

## ライブラリ構造
aily blocklyライブラリは基本的にgoogle blocklyライブラリ構造に従い（現在はblockly 11を使用）、npmパッケージ管理形式を使用してライブラリのバージョンと関連する必要な情報を管理します。aily blocklyライブラリの構造は以下のとおりです：
```
library-name  
 |- block.json             // aily blockly blockファイル
 |- generator.js           // aily blockly generatorファイル
 |- toolbox.json           // aily blockly toolboxファイル
 |- package.json           // npmパッケージ管理ファイル
 |- src.7z                 // Arduinoライブラリソースファイル、7z極限圧縮を使用してライブラリに配置してください
 |- readme.md              // 説明ファイル、オープンソースライブラリを使用している場合は説明してください
```

## block.json
aily blockly jsonは元のblockly jsonを拡張しています。ここではservo lib（サーボライブラリ）を例に説明します。サーボライブラリのjsonは以下のとおりです：
```json
[
    {
        "inputsInline": true,
        "message0": "サーボ%1を%2に移動",
        "type": "servo_write",
        "args0": [
            {
                "type": "field_variable",
                "name": "OBJECT",
                "variable": "servo1",
                "variableTypes": [
                    "Servo"
                ],
                "defaultType": "Servo"
            },
            {
                "type": "field_number",
                "name": "ANGLE",
                "value": 0
            }
        ],
        "previousStatement": null,
        "nextStatement": null,
        "colour": "#03a9f4"
    },
    {
        "inputsInline": true,
        "message0": "サーボ%1をピン%2に接続",
        "type": "servo_attach",
        "args0": [
            {
                "type": "field_variable",
                "name": "OBJECT",
                "variable": "servo1",
                "variableTypes": [
                    "Servo"
                ],
                "defaultType": "Servo"
            },
            {
                "type": "field_dropdown",
                "name": "PIN1",
                "options": "${board.digitalPins}"
            }
        ],
        "previousStatement": null,
        "nextStatement": null,
        "colour": "#03a9f4"
    }
]
```

### block設定  
jsonファイル内の`blocks配列`が具体的なblock設定です。[blockly公式ドキュメント](https://developers.google.com/blockly/guides/create-custom-blocks/define-blocks)を参照して関連設定を理解できます。  
単一blockの例は以下のとおりです：

```json
{
    "inputsInline": true,              // blockスタイル、true入力項目は1行表示、falseは複数行表示
    "message0": "サーボ%1をピン%2に接続",   // block情報、このblockに表示される内容を定義
    "type": "servo_attach",           // blockタイプ、このパラメータは一意である必要があります
    "previousStatement": null,         // 前の接続、このblockの前のblockタイプを設定  
    "nextStatement": null,             // 後の接続、このblockの後のblockタイプを設定  
    "colour": "#03a9f4",               // block色
    "args0": [                         // 入力項目
        {
            "type": "field_variable",
            "name": "OBJECT",
            "variable": "servo1",
            "variableTypes": [
                "Servo"
            ],
            "defaultType": "Servo"
        },
        {
            "type": "field_dropdown",
            "name": "PIN1",
            "options": "${board.digitalPins}"
        }
    ]
}
```

## generator.js 
generator.jsはblockをコードに変換する責任があり、各blockには対応するgenerator関数があります。Arduinoライブラリの場合、generator関数の書き方は以下を参照できます：
```javascript
Arduino.forBlock['servo_attach'] = function(block, generator) {
  // 実装コードはblockly公式ドキュメントを参照
  return ''
};

Arduino.forBlock['servo_write'] = function(block, generator) {
  // 実装コードはblockly公式ドキュメントを参照
  return ''
};
```

### 追加コードの追加
generator.jsでblockに対応するコードはreturnを使用して返されます。ほとんどのArduinoでは、blockに対応するコードの他に、追加のコードを追加する必要があります。例えば、servoライブラリを呼び出すには、ライブラリ参照を追加し、Servoオブジェクトを作成する必要があります：
```c++
#include <Servo.h>
Servo myservo;
```
この場合、generator.jsの対応する関数に次のステートメントを追加して、プログラムの他の場所にライブラリ参照と新しいオブジェクトステートメントを追加できます：
```javascript
Arduino.forBlock['servo_attach'] = function(block, generator) {
  generator.addLibrary('#include <Servo.h>','#include <Servo.h>');
  generator.addObject('Servo myservo','Servo myservo');
  // 実装コードはblockly公式ドキュメントを参照
  return ''
};
```

使用可能な関数は以下のとおりです：
```javascript
addMacro(tag, code);
addLibrary(tag, code);
addVariable(tag, code);
addObject(tag, code);
addFunction(tag, code);
addSetupBegin(tag, code);
addSetup(tag, code); //システムデフォルト、ライブラリでの使用は推奨されません
addSetupEnd(tag, code);
addLoopBegin(tag, code);
addLoop(tag, code); //システムデフォルト、ライブラリでの使用は推奨されません
addLoopEnd(tag, code);
```
ここでtagは重複コード追加を避けるためのタグ、codeは実際に挿入されるコードです。

## toolbox.json 
Toolboxはblocklyインターフェースの左側に表示されるblockメニューです。例は以下のとおりです：
```json
{
    "kind": "category",
    "name": "Servo",
    "contents": [
        {
            "kind": "block",
            "type": "servo_attach"
        },
        {
            "kind": "block",
            "type": "servo_write"
        }
    ]
}
```

## package.json
バージョン管理ファイル、npmパッケージ管理を採用。例は以下のとおりです：
```json
{
    "name": "@aily-project/lib-servo",  // ライブラリのパッケージ名は @aily-project/lib- で始まる
    "nickname":"サーボドライバーライブラリ",             // ライブラリマネージャーに表示される名前
    "author": "aily Project",
    "description": "サーボ制御サポートライブラリ、Arduino UNO、MEGA、ESP8266、ESP32などの開発ボードをサポート", // 簡単な紹介、50文字以内
    "version": "0.0.1",
    "compatibility": {                  // 互換性の説明、サポートされているコアと電圧
        "type": [                       // []の場合、汎用ライブラリで、すべての開発ボードと互換性があります
            "arduino:avr:uno",
            "esp32:esp32:esp32",
            "esp32:esp32:esp32c3",
            "esp32:esp32:esp32s3",
            "arduino:renesas_uno:nanor4",
            "arduino:renesas_uno:nanor4"
        ],
        "voltage": [3.3,5]
    },
    "keywords": [                       // keywordsはライブラリの検索を支援できます。カテゴリ名、関数名などを追加することをお勧めします
        "aily",
        "blockly",
        "servo",
        "servo_attach",
        "servo_write",
    ],
    "scripts": {},
    "dependencies": {},                // このライブラリが依存する他のライブラリ
    "devDependencies": {}
}
```

### パッケージ名の命名規則
ライブラリは@aily-project/lib-xxxxの形式で命名されます（例：@aily-project/lib-servo）。
ライブラリがほとんどの開発ボードで汎用的な場合、コアライブラリと呼び、@aily-project/lib-core-xxxxの形式で命名されます（例：@aily-project/lib-core-io）。
