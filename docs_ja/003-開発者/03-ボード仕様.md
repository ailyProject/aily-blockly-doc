# ボード設定仕様 


## ボード設定ライブラリ構造
aily blocklyライブラリは基本的にgoogle blocklyライブラリ構造に従い、npmパッケージ管理形式を使用してライブラリのバージョンと関連する必要な情報を管理します。aily blocklyライブラリの構造は以下のとおりです：
```
board_name  
 |- board.json             // ボード設定ファイル
 |- board.webp             // ボード画像
 |- package.json           // npmパッケージ管理ファイル
 |- example                // サンプルプログラムフォルダ
    |- <サンプルプログラムリスト>
 |- template               // 初期テンプレートフォルダ
    |- package.json
    |- project.abi
```

## board-name.json
ここではArduino UNOを参考として提供します：
```json
{
    "name": "Arduino UNO",
    "version":"1.0.0",
    "description": "Arduino UNO standard compatible board",
    "compilerTool": "aily-builder",  // デフォルトで使用するコンパイルツール
    "type": "arduino:avr:uno",  // arduinoでのタイプ
    "mode": ["arduino", "micropython"],  // サポートされる開発フレームワーク
    "compilerParam": "compile -v -b arduino:avr:uno",  // コンパイルコマンド
    "uploadParam": "upload -v -b arduino:avr:uno -p ${serial}",  // アップロードコマンド
    "analogPins": [
        ["A0","A0"],["A1","A1"],["A2","A2"],["A3","A3"],["A4","A4"],["A5","A5"]
    ],
    "digitalPins": [
        ["0","0"],["1","1"],["2","2"],["3","3"],["4","4"],["5","5"],["6","6"],["7","7"],["8","8"],["9","9"],["10","10"],["11","11"],["12","12"],["13","13"],["A0","A0"],["A1","A1"],["A2","A2"],["A3","A3"],["A4","A4"],["A5","A5"]
    ],
    "pwmPins": [
        ["3","3"],["5","5"],["6","6"],["9","9"],["10","10"],["11","11"]
    ],
    "serialPort": [
        ["Serial","Serial"]
    ],
    "serialSpeed": [
        ["1200","1200"],["9600","9600"],["14400","14400"],["19200","19200"],["38400","38400"],["57600","57600"],["115200","115200"]
    ],
    "spi": [
        ["SPI","SPI"]
    ],
    "spiPins": {
        "SPI": [
            ["MOSI",11],["MISO",12],["SCK",13]
        ]
    },
    "i2c": [
        ["I2C","Wire"]
    ],
    "i2cPins": {
        "Wire": [
            ["SDA","A4"],["SCL","A5"]
        ]
    },
    "builtinLed": [
        ["BUILTIN_LED","13"]
    ],
    "interruptPins": [
        ["2","2"],["3","3"]
    ]
}
```

### コンパイルとアップロードの設定
```json
    "compilerTool": "aily-builder",  // 使用するコンパイルツール、現在はarduino-cli、変更不要
    "core": "arduino:avr@1.8.5",    // ボードコアと対応するバージョン番号
    "type": "arduino:avr:uno",      // ボードタイプ
    "compilerParam": "compile -v -b arduino:avr:uno",  //コンパイルパラメータ
    "uploadParam": "upload -v -b arduino:avr:uno -p ${serial}",  //アップロードパラメータ、${serial}はシリアルポート変数で、実際の使用時にユーザーが選択したシリアルポートに置き換えられます
```

#### 使用可能な設定
 ${serial} はユーザーが選択したデバイスのシリアルポート  
 ${mac} はワイヤレスダウンロード時にユーザーが選択したデバイス、Bluetooth可、WiFi可  
 ${usb} はUSBダウンロード時にユーザーが選択したデバイス  

#### arduino-cliリファレンス
現在の設定はarduino cli設定を参照しています。[arduino-cliドキュメント](https://arduino.github.io/arduino-cli)を参照してください  

使用する可能性のあるコマンド：
```bash
arduino-cli core list // インストールされたコアを一覧表示
arduino-cli board search // 使用可能なボードを一覧表示
```

## package.json
基本的にnpmパッケージ管理仕様に従います。`boardDependencies`項目にはボードのコンパイル、アップロードなどのアクションに使用される依存関係が含まれています。異なるコアの参照依存関係は以下のとおりです：
```json
// AVRコア、Arduino UNO\MEGA\LEONARDOなどのボード用
{
    "@aily-project/compiler-avr-gcc": "7.3.0",
    "@aily-project/tool-avrdude": "6.3.0",
    "@aily-project/sdk-avr": "1.8.6",
    "@aily-project/tool-ctags": "5.8.0"
}
```  
```json
// Renesas RA4M1コア、Arduino UNO R4シリーズなど
{
    "@aily-project/compiler-arm-none-eabi-gcc": "7.2.1",
    "@aily-project/tool-bossac": "1.9.1",
    "@aily-project/sdk-renesas_uno": "1.3.2",
    "@aily-project/tool-ctags": "5.8.0",
    "@aily-project/tool-dfu-util": "0.11.0"    
}
```
```json
// ESP32コア
{
    "@aily-project/compiler-esp-x32": "14.2.0",
    "@aily-project/tool-esptool_py": "5.1.0",
    "@aily-project/sdk-esp32": "3.3.1",
    "@aily-project/tool-idf_esp32": "5.5.0",
    "@aily-project/tool-ctags": "5.8.0"
}
```

## 初期プロジェクトテンプレート（template）
各ボードパッケージには`template`ディレクトリがあり、新しいプロジェクトを作成した後にロードされるテンプレートプロジェクトが格納されています。
`template\package.json`を変更してデフォルトでロードされるライブラリを追加できます。

`template\project.abi`は対応するblocklyワークスペースファイルです。デフォルトのproject.abiは通常以下のようになります：
```json
{
  "blocks": {
    "languageVersion": 0,
    "blocks": [
      {
        "type": "arduino_setup",
        "id": "arduino_setup_id0",
        "x": 30,
        "y": 30,
        "deletable": false 
      },
      {
        "type": "arduino_loop",
        "id": "arduino_loop_id0",
        "x": 30,
        "y": 290,
        "deletable": false 
      }
    ]
  }
}
```
事前に編集したプロジェクトを書き込むこともでき、ユーザーがこのボードを使用して新しいプロジェクトを作成すると、このプログラムが自動的にロードされます。
